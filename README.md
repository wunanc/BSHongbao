# BSHongbao 红包插件

一个为 Minecraft 服务器提供“红包”玩法的插件，支持普通红包与拼手气红包两种模式，集成 Vault 经济，带可视化 GUI，自动过期退款与并发安全设计。

## 功能特性
- 🧧 两种红包类型：普通（平均分配）与拼手气（随机分配）
- 💰 Vault 经济集成：通过 Vault 与主流经济插件兼容
- 🎨 GUI 操作：在游戏内以菜单引导完成红包创建
- ⏰ 自动过期与退款：到期未领完的金额自动退还给发送者
- 🔒 并发安全：领取操作加锁，防止重复领取/并发竞态
- 📎 聊天可点击领取：广播可点击消息，一键领取
- 🌐 版本兼容：API 1.16，实测支持 1.16+ 服务器（Spigot/Paper）

## 环境依赖
- 服务器：Spigot/Paper 1.16+
- 插件：Vault + 任一经济插件（如 EssentialsX 经济）

## 安装与启用
1. 确保服务器已安装 Vault 与经济插件并正常工作。
2. 将构建出的 `BSHongbao-1.1.0.jar` 放入服务器 `plugins/` 目录。
3. 启动/重启服务器，插件将自动生成默认配置文件。

## 指令与权限
- 指令（主命令及别名）
  - `/BSHongbao open` 打开红包 GUI
  - `/hongbao open` 同上
  - `/redpacket open` 同上
  - `/BSHongbao reload` 重载配置（需要管理员权限）
  - `/BSHongbao info` 查看运行信息（需要管理员权限）
- 权限
  - `bshongbao.use` 基本使用权限（默认所有玩家）
  - `bshongbao.admin` 管理权限（默认 OP）

## 使用方法
- 发送红包
  1) 使用 `/BSHongbao open` 打开 GUI
  2) 选择红包类型（普通/拼手气）
  3) 按提示在聊天输入总金额与份数
  4) 成功扣款后将自动广播可点击的领取消息
- 领取红包
  - 聊天中点击“[点击领取]”，系统自动完成领取与入账
  - 每名玩家对同一红包仅能领取一次；发送者不能领取自己的红包

## 配置说明（摘录）
文件：`plugins/BSHongbao/config.yml`
- redpacket.min-total-amount：最小红包总额（默认 1000.00）
- redpacket.max-packet-count：最大份数（默认 50）
- redpacket.expiration-minutes：过期时间（分钟，默认 5）
- redpacket.min-single-amount：单个最小金额（默认 0.01）
- messages.*：前缀/提示/错误/广播等文本
- items.*：GUI 物品与槽位
- debug：调试日志开关

## 实现要点（简要）
- 红包创建即从发送者余额一次性扣款（通过 Vault）
- 红包内部金额按类型生成（普通=平均，拼手气=二倍均值法）
- 领取过程使用同步加锁，且对过期/已领完/重复领取均进行判定
- 定时任务轮询过期红包，剩余金额自动加入待退款并在玩家在线时结算

## 安全性与已知问题（重要）
以下条目是当前实现中需要注意的风险点与改进建议（本次仅提示，不做改动）：
- 经济与部分 Bukkit API 在异步聊天回调中被调用。
  - 影响：`AsyncPlayerChatEvent` 路径中执行扣款、创建红包与广播，可能导致并发不安全、随机报错甚至被恶意刷崩。建议将扣款+创建+广播封装为主线程任务执行。
- 领取时“入账失败”的补偿缺失。
  - 影响：若 Vault 存款失败，系统仅提示错误，已占用的该份金额不会回滚到红包或加入退款，可能造成资金遗失。建议在存款失败时将该份金额重新回退到红包或加入发送者待退款。
- 未强制校验“单份最低金额”与配置项一致。
  - 影响：拼手气红包内部已保障单份最低 0.01，但未与 `redpacket.min-single-amount` 动态联动，若服主配置更高阈值，实际生成可能低于配置。建议在金额生成前基于配置进行校验与调整。
- 持久化缺失导致异常重启时资金风险。
  - 影响：红包与待退款记录存于内存，若服务器/进程异常崩溃，可能出现已扣款但红包/退款状态丢失，造成损失。建议引入文件/数据库持久化与启动时恢复。
- 小额金额的浮点/四舍五入差异风险。
  - 影响：插件内部使用 BigDecimal 保留两位，但 Vault 接口以 double 交互，极端情况下不同经济实现的舍入策略差异可能导致微小误差。建议对接经济插件的最小货币单位进行对齐校验（例如禁止小于最小单位的红包）。
- 速率限制与冷却未实现。
  - 影响：玩家可在余额允许范围内高频创建红包，可能用于刷屏/骚扰。建议加入冷却、每人同时活跃红包上限等限制（非直接“刷钱”，但属于滥用风险）。

以上风险不会直接产生“凭空刷钱”的路径（扣款在创建时即完成，领取仅做再分配），但在极端环境下可能造成“资金丢失”或“服务不稳定”问题，建议尽快完善。

## 版本信息
- 插件版本：1.1.0
- API 版本：1.16
- 作者：sigmoid

—— 祝你和你的玩家玩得开心！🧧✨